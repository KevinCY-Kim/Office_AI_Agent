{% include 'includes/_top.html' %}
<form action="stats" method="post" enctype="multipart/form-data">
<div id="stats-wrapper">
  <div class="container">
    <!-- ===== ì™¼ìª½ ì‚¬ì´ë“œë°” ===== -->
    <aside class="sidebar left">
        <!-- íŒŒì¼ ì—…ë¡œë“œ -->
        <label for="file">ğŸ“ [íŒŒì¼ ì—…ë¡œë“œ]</label>
        <input type="file" id="file" name="file" accept=".csv, .xlsx, .xls" required>
        <p id="loadingMsg" style="display:none;">ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤. ğŸŒ€</p>
        <hr>

        <!-- ğŸ“Š ë¶„ì„ ìœ í˜• -->
        <label for="analysis_type">[ë¶„ì„ ìœ í˜•]</label>
        <select id="analysis_type" name="analysis_type" onchange="toggleInputs()">
          <option value="">-- ì„ íƒ --</option>
          <option value="ttest">t-test</option>
          <option value="anova_one">one-way ANOVA</option>
          <option value="anova_two">two-way ANOVA</option>
          <option value="anova_repeated">repeated ANOVA</option>
          <option value="correlation">Correlation</option>
        </select>

        <!-- ê³µí†µ ë³€ìˆ˜ -->
        <label for="value_col">| ë³€ìˆ˜ (Value)</label>
        <input type="text" id="value_col" name="value_col" placeholder="ì˜ˆ: Sales">

        <label for="alpha">| p-value (ê¸°ë³¸ê°’)</label>
        <input type="text" id="alpha" name="alpha" value="0.05">

        <!-- t-test -->
        <div id="ttest_fields" style="display:none;">
          <label>| ê·¸ë£¹ ë³€ìˆ˜ (group)</label>
          <input type="text" id="group_col_ttest" name="group_col_ttest" placeholder="ì˜ˆ: City">
          <label>| ê·¸ë£¹1</label>
          <input type="text" id="group1" name="group1" placeholder="ì˜ˆ: high_region">
          <label>| ê·¸ë£¹2</label>
          <input type="text" id="group2" name="group2" placeholder="ì˜ˆ: low_region">
        </div>

        <!-- One-way ANOVA -->
        <div id="anova_one_fields" style="display:none;">
          <label>| ê·¸ë£¹ ë³€ìˆ˜</label>
          <input type="text" id="group_col_one" name="group_col_one" placeholder="ì˜ˆ: Product Class">
        </div>

        <!-- Two-way ANOVA -->
        <div id="anova_two_fields" style="display:none;">
          <label>| ê·¸ë£¹ ë³€ìˆ˜</label>
          <input type="text" id="group_col_two" name="group_col_two" placeholder="ì˜ˆ: Channel">
          <label>| ìš”ì¸ (factors)</label>
          <input type="text" id="factors_two" name="factors_two" placeholder="ì˜ˆ: Product Class, Channel">
        </div>

        <!-- Repeated ANOVA -->
        <div id="anova_repeated_fields" style="display:none;">
          <label>| ë°˜ë³µ ì¸¡ì • ë³€ìˆ˜ (within)</label>
          <input type="text" id="within" name="within" placeholder="ì˜ˆ: Year, Month">
          <label>| ê°œì²´ ë³€ìˆ˜ (subject)</label>
          <input type="text" id="subject" name="subject" placeholder="ì˜ˆ: Product Class">
        </div>

        <!-- Correlation -->
        <div id="corr_fields" style="display:none;">
          <label>| ë³€ìˆ˜1</label>
          <input type="text" id="var1" name="var1" placeholder="ì˜ˆ: Quantity">
          <label>| ë³€ìˆ˜2</label>
          <input type="text" id="var2" name="var2" placeholder="ì˜ˆ: Sales">
          <label>| Method (ì„ íƒì‚¬í•­)</label>
          <select id="method" name="method" disabled>
            <option value="pearson">Pearson</option>
            <option value="spearman">Spearman</option>
          </select>
          <small id="methodInfo" style="color:gray;">ìë™ ì„ íƒ ê°€ëŠ¥</small>
        </div>

        <hr>
        <button type="submit" id="run_analysis">ğŸ” ë¶„ì„ ì‹¤í–‰</button>
        <button type="reset" id="reset_form">ğŸ”„ ì´ˆê¸°í™”</button>
    </aside>

    <!-- ===== ì¤‘ì•™ ì˜ì—­ ===== -->
    <section class="main">
      <h2>ê²°ê³¼ ë° ì‹œê°í™”</h2>
      <div id="resultArea">
      </div>
      <div class="bottom-box">
        <div class="bottom-right">
          <h3>ê´€ë ¨ í†µê³„ ì¶”ì²œ</h3>
          <p>ì—…ë¡œë“œëœ ìë£Œì— ê¸°ë°˜í•œ ë¶„ì„ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
      </div>
    </section>

    <!-- ===== ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” ===== -->
    <aside class="sidebar right">
      <div class="officemate-helper">
        <h3>OfficeMate </h3>
        <section container>ì±„íŒ…ì°½</section>
        <p class="button-group">í†µê³„ ìˆ˜í–‰ ë„êµ¬ ì„ íƒ</p>
        <div class="tool-buttons">
          <button>SPSS</button>
          <button>SAS</button>
          <button>R</button>
        </div>
      </div>
      <div class="input-section">
        <input type="text" placeholder="ì§ˆë¬¸ ì…ë ¥">
        <button id="saveBtn">ì…ë ¥</button>
      </div>
    </aside>

  </div><!-- /.container -->
</div><!-- /#stats-wrapper -->
</form>

<style>
  /* âœ… ì „ì—­ ì˜í–¥ ì°¨ë‹¨: í†µê³„ í˜ì´ì§€ ë…ë¦½ ìŠ¤ì½”í”„ */
  #stats-wrapper {
    all: initial;
    * { all: unset; display: revert; }
    display: block;
    font-family: 'Noto Sans KR', sans-serif;
    background-color: #f7f8fc;
    color: #222;
    box-sizing: border-box;
  }

  /* ===== ê¸°ë³¸ ì„¤ì • ===== */
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
  #stats-wrapper html, 
  #stats-wrapper body { height: 100%; margin: 0; padding: 0; overflow-x: hidden; overflow-y: auto; }
  #stats-wrapper body { margin: 0; font-family: 'Noto Sans KR', sans-serif; background-color: #f7f8fc; color: #222; overflow-x: hidden; }

  #stats-wrapper .logo { font-weight: bold; font-size: 20px; }

  #stats-wrapper .nav-links button {
    background: transparent; color: white; border: none; margin: 0 8px; cursor: pointer; font-weight: 500;
  }
  #stats-wrapper .nav-links button:hover,
  #stats-wrapper .nav-links .active { text-decoration: underline; color: #38cb9a; }

  /* ===== ì „ì²´ ë ˆì´ì•„ì›ƒ ===== */
  #stats-wrapper .container {
    display: flex; flex-direction: row; flex-wrap: nowrap;
    min-height: calc(100vh - 100px);
    padding: 20px; gap: 20px; box-sizing: border-box;
    margin: 0 auto; max-width: 1400px;
  }

  /* ===== ì‚¬ì´ë“œë°” ===== */
  #stats-wrapper .sidebar {
    flex: 0 0 280px; background: #e8ebf2; border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    padding: 20px; box-sizing: border-box;
    display: flex; flex-direction: column; justify-content: flex-start;
  }

  #stats-wrapper .sidebar label { font-weight: 600; margin-top: 10px; color: #120277; }

  #stats-wrapper .sidebar input,
  #stats-wrapper .sidebar select {
    width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ccc; margin-top: 5px; font-size: 14px;
  }

  #stats-wrapper .sidebar button {
    background-color: #38cb9a; color: #fff; border: none; border-radius: 6px;
    padding: 8px 12px; margin-top: 10px; cursor: pointer; transition: all .25s ease;
  }
  #stats-wrapper .sidebar button:hover { background-color: #2da885; transform: translateY(-2px); }

  #stats-wrapper .upload-note { margin-top: 15px; font-size: 13px; text-align: center; color: gray; }

  /* ===== ë©”ì¸ ì˜ì—­ ===== */
  #stats-wrapper .main {
    flex: 1; background: #fff; border-radius: 10px; padding: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    display: flex; flex-direction: column; min-width: 0;
  }
  #stats-wrapper .main h2 { color: #120277; border-bottom: 2px solid #eee; padding-bottom: 5px; }

  #stats-wrapper #resultArea {
    flex: 1; background: #f3f6fa; border-radius: 10px; padding: 15px;
    overflow-y: auto; font-family: monospace; white-space: pre-wrap; margin-top: 15px;
  }

  /* ===== ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” OfficeMate ë„ìš°ë¯¸ ===== */
  #stats-wrapper .officemate-helper { display: flex; flex-direction: column; align-items: flex-start; gap: 15px; }
  #stats-wrapper .tool-section { width: 100%; }
  #stats-wrapper .tool-section p { margin-bottom: 8px; font-weight: 600; color: #120277; }

  #stats-wrapper .tool-buttons { display: flex; justify-content: space-between; gap: 8px; }
  #stats-wrapper .tool-buttons button {
    flex: 1; background-color: #38cb9a; color: #fff; border: none; border-radius: 6px;
    padding: 8px 14px; cursor: pointer; transition: all .25s ease; text-align: center;
  }
  #stats-wrapper .tool-buttons button:hover { background-color: #2da885; transform: translateY(-2px); }

  /* ===== ì…ë ¥ì˜ì—­ ===== */
  #stats-wrapper .input-section { display: flex; width: 100%; gap: 10px; }
  #stats-wrapper .input-section input { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
  #stats-wrapper .input-section button { background-color: #6863ff; color: #fff; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; }
  #stats-wrapper .input-section button:hover { background-color: #504ad9; }

  /* ===== í•˜ë‹¨ ì˜ì—­ ===== */
  #stats-wrapper .bottom-box { display: flex; justify-content: space-between; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
  #stats-wrapper .bottom-box h3 { color: #333; }
  #stats-wrapper .bottom-box p { font-size: 14px; color: #666; }

  /* ===== í‘¸í„° ===== */
  #stats-wrapper footer {
    background-color: #120277; color: #fff; text-align: center; padding: 15px;
    font-size: 14px; line-height: 1.6; margin-top: 20px;
  }
</style>

<script>
  
// í•„ë“œ í† ê¸€ í•¨ìˆ˜
function toggleInputs() {
  const type = document.getElementById("analysis_type").value;
  // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¹€
  document.querySelectorAll("#ttest_fields, #anova_one_fields, #anova_two_fields, #anova_repeated_fields, #corr_fields")
    .forEach(div => div.style.display = "none");

  // ì„ íƒëœ ìœ í˜•ë§Œ í‘œì‹œ
  if (type === "ttest") document.getElementById("ttest_fields").style.display = "block";
  if (type === "anova_one") document.getElementById("anova_one_fields").style.display = "block";
  if (type === "anova_two") document.getElementById("anova_two_fields").style.display = "block";
  if (type === "anova_repeated") document.getElementById("anova_repeated_fields").style.display = "block";
  if (type === "correlation") document.getElementById("corr_fields").style.display = "block";
}


document.addEventListener("DOMContentLoaded", function() {
  const form = document.querySelector("form");
  const resultArea = document.querySelector("#resultArea");
  const loadingMsg = document.querySelector("#loadingMsg");

  form.addEventListener("submit", async function(e) {
    e.preventDefault();  // í¼ ê¸°ë³¸ ë™ì‘(ìƒˆë¡œê³ ì¹¨) ë§‰ê¸°
    loadingMsg.style.display = "block"; // ì—…ë¡œë“œ ë©”ì‹œì§€ í‘œì‹œ

    const formData = new FormData(form);

    try {
      const response = await fetch("http://127.0.0.1:8001/statistics/stats", {
        method: "POST",
        body: formData,
      });

      if (!response.ok) {
        throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: " + response.status);
      }
      let chunks = [];
      // FastAPIê°€ HTMLì„ ë°˜í™˜í•œë‹¤ê³  ê°€ì •
      const html = await response.body.getReader();
      while (true) {
        const { done, value } = await html.read();
        if (done) break;

        chunks.push(value);
      }
      // ê²°ê³¼ë¥¼ resultArea ì•ˆì— ì‚½ì…
      const blob = new Blob(chunks, { type: "image/jpeg" });
      const url = URL.createObjectURL(blob);
      const img = document.createElement("img");
      img.src = url;
      img.style = "width:600px; margin:30px;";
      resultArea.appendChild(img);
    } catch (err) {
      console.error(err);
      resultArea.innerHTML = `<p style="color:red;">ì˜¤ë¥˜ ë°œìƒ: ${err.message}</p>`;
    } finally {
      loadingMsg.style.display = "none";
    }
  });
  resetBtn.addEventListener("click", () => {
    document.querySelectorAll("input").forEach(input => (input.value = ""));
    document.getElementById("analysis_type").value = "";
    toggleInputs();
    $("#resultArea").emtpy();
    document.getElementById("methodInfo").textContent = "ìë™ ì„ íƒ ê°€ëŠ¥";
  });
});

</script>
{% include 'includes/_bottom.html' %}
